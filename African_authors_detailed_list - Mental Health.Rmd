---
title: "African_authors_detailed_list- Mental Health Screen tool"
author: "Reinpeter"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    number_sections: yes
  word_document: 
    number_sections: yes
---

# **Introduction**

```{r setup, results="hide", include=FALSE}

## Set Chunk requirements
knitr::opts_chunk$set(#include = TRUE,
                      echo=FALSE, message = FALSE, warning = FALSE)

```

```{r setting working directory, include=FALSE}

## Setting work directory

setwd(".")

```

```{r loading relevant packages, include=FALSE}

#library we need
libs_mental_health <- c("googledrive", "tidyverse", "janitor", "knitr", "readxl", "writexl", "DiagrammeR", "DiagrammeRsvg",
                        "rsvg")

#install missing libraries

inatalled_libs_mental_health <- libs_mental_health  %in% rownames(installed.packages())
if (any(inatalled_libs_mental_health==F)) {
  install.packages(libs_mental_health[!inatalled_libs_mental_health])
}

#load libraries

invisible(lapply(libs_mental_health, library, character.only=T))


```

```{r googledrive downloading data, include=FALSE}

 drive_auth(#email = "guest360@aphrc.org"
           )

  #drive_user()

  mental_file_id <- drive_find(shared_drive = c(shared_drive_find(pattern = "Data Science Programs")$id),
           q = c("name contains 'Mental Health'",
                 "mimeType = 'application/vnd.google-apps.shortcut'")) #search for a specific set of shared drives, use the query string q

  list_files_shortcut_folder <- drive_ls(path = mental_file_id$id, q = c("name contains 'African_authors_detailed_list (2) (1).xlsx'"))
  
  
  mental_local_download <- drive_download(list_files_shortcut_folder$id, overwrite = TRUE)
  
```

# **Inclusion/Exclusion**

```{r reading data, include=FALSE}

  mental_health_publications <- read_excel(paste0(mental_local_download$local_path), sheet = "African_authors_detailed_list (")%>%
  janitor::clean_names()

```


```{r distinct titles, include=FALSE}

mental_health_publications_distinct <- mental_health_publications%>%
  mutate(source_title = str_to_title(source_title)
         ,source_title = gsub("\\.$", "", source_title) #remove period at end of title
         )%>%
  distinct(source_title, .keep_all = TRUE)

```


```{r inclusion data}

mental_health_publications_inclusion_final <- mental_health_publications_distinct%>%
  filter(str_detect(source_title, regex("psychosis|depression|anxiety|depressive|depressed|
                                        \\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia|
                                       \\bmental health disorders\\b|\\bmental disorders\\b|
                                        \\bmental health disorder\\b|\\bmental disorder\\b|
                                        \\bmental health problems\\b|\\bmental problems\\b|
                                        \\bmental health problem\\b|\\bmental problem\\b|
                                       \\bmental health illness\\b|\\bmental illness\\b|\\bmental health conditions\\b",
                                        ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex(paste(c("psychosis", "depression", "anxiety","depressive" , "depressed",
                                                    "\\bsocial phobia\\b", "phobia", "\\bpanic disorder\\b", "agoraphobia",
                                                    "\\bmental health disorders\\b","\\bmental disorders\\b",
                                                    "\\bmental health disorder\\b","\\bmental disorder\\b",
                                                    "\\bmental health problems\\b","\\bmental problems\\b",
                                                    "\\bmental health problem\\b","\\bmental problem\\b",
                                                    "\\bmental health illness\\b","\\bmental illness\\b",
                                                    "\\bmental health conditions\\b"),
                                                         collapse = '|'),
                                        ignore_case = TRUE) )
         )

```


```{r exclusion data}

mental_health_publications_exclusion_final <- mental_health_publications_distinct%>%
  filter(!str_detect(source_title, regex("psychosis|depression|anxiety|depressive|depressed|
                                        \\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia|
                                       \\bmental health disorders\\b|\\bmental disorders\\b|
                                        \\bmental health disorder\\b|\\bmental disorder\\b|
                                        \\bmental health problem\\b|\\bmental problem\\b|
                                        \\bmental health problems\\b|\\bmental problems\\b|
                                       \\bmental health illness\\b|\\bmental illness\\b|\\bmental health conditions\\b",
                                        ignore_case = TRUE)) &
         !str_detect(source_fields_of_study,  regex(paste(c("psychosis", "depression", "anxiety","depressive" , "depressed",
                                                    "\\bsocial phobia\\b", "phobia", "\\bpanic disorder\\b", "agoraphobia",
                                                    "\\bmental health disorders\\b","\\bmental disorders\\b",
                                                    "\\bmental health disorder\\b","\\bmental disorder\\b",
                                                    "\\bmental health problems\\b","\\bmental problems\\b",
                                                    "\\bmental health problem\\b","\\bmental problem\\b",
                                                    "\\bmental health illness\\b","\\bmental illness\\b",
                                                    "\\bmental health conditions\\b"),
                                                         collapse = '|'),
                                        ignore_case = TRUE) )
         )

```


```{r longitudinal cross sectional reviews Randomized trials}

longitudinal_publications_final <- mental_health_publications_inclusion_final%>%
  filter(str_detect(source_title, regex("longitudinal|\\bcohort study\\b",ignore_case = TRUE)) |
         str_detect(source_fields_of_study, regex("longitudinal|\\bcohort study\\b",ignore_case = TRUE) )
         )

cross_sectional_publications_final <- mental_health_publications_inclusion_final%>%
  filter(!str_detect(source_title, regex("longitudinal|\\bcohort study\\b", ignore_case = TRUE)) &
         !str_detect(source_fields_of_study, regex("longitudinal|\\bcohort study\\b", ignore_case = TRUE) )
         )

```


```{r longitudinal psychosis depression anxiety data}

longitudinal_psychosis_publications_final <- longitudinal_publications_final%>%
  filter(str_detect(source_title, regex("psychosis", ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("psychosis", ignore_case = TRUE) )
         )

longitudinal_depression_publications_final <- longitudinal_publications_final%>%
  filter(str_detect(source_title, regex("depression|depressive|depressed", ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("depression|depressive|depressed", ignore_case = TRUE) )
         )

longitudinal_anxiety_publications_final <- longitudinal_publications_final%>%
  filter(str_detect(source_title, regex("anxiety|\\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia",
                                        ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("anxiety|\\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia",
                                                   ignore_case = TRUE) )
         )

```


```{r cross-sectional psychosis depression anxiety data}

cross_sectional_psychosis_publications_final <- cross_sectional_publications_final%>%
  filter(str_detect(source_title, regex("psychosis", ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("psychosis", ignore_case = TRUE) )
         )

cross_sectional_depression_publications_final <- cross_sectional_publications_final%>%
  filter(str_detect(source_title, regex("depression|depressive|depressed", ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("depression|depressive|depressed", ignore_case = TRUE) )
         )

cross_sectional_anxiety_publications_final <- cross_sectional_publications_final%>%
  filter(str_detect(source_title, regex("anxiety|\\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia",
                                        ignore_case = TRUE)) |
         str_detect(source_fields_of_study,  regex("anxiety|\\bsocial phobia\\b|phobia|\\bpanic disorder\\b|agoraphobia",
                                                   ignore_case = TRUE) )
         )

```


# **FlowChart**

```{r flow chart}

data <- list(a=nrow(mental_health_publications), a_oldest=min(mental_health_publications$source_year_published),
             a_newest = max(mental_health_publications$source_year_published),
             b=nrow(mental_health_publications_distinct), b_oldest=min(mental_health_publications_distinct$source_year_published),
             b_newest = max(mental_health_publications_distinct$source_year_published),
             c=nrow(mental_health_publications_inclusion_final), 
             c_oldest=min(mental_health_publications_inclusion_final$source_year_published),
             c_newest = max(mental_health_publications_inclusion_final$source_year_published),
             d= nrow(cross_sectional_publications_final), d_oldest=min(cross_sectional_publications_final$source_year_published),
             d_newest = max(cross_sectional_publications_final$source_year_published),
             e = nrow(longitudinal_publications_final), e_oldest=min(longitudinal_publications_final$source_year_published),
             e_newest = max(longitudinal_publications_final$source_year_published),
             f = nrow(cross_sectional_depression_publications_final),
             f_oldest=min(cross_sectional_depression_publications_final$source_year_published),
             f_newest = max(cross_sectional_depression_publications_final$source_year_published),
             g = nrow(cross_sectional_anxiety_publications_final),
             g_oldest=min(cross_sectional_anxiety_publications_final$source_year_published),
             g_newest = max(cross_sectional_anxiety_publications_final$source_year_published),
             h = nrow(cross_sectional_psychosis_publications_final),
             h_oldest=min(cross_sectional_psychosis_publications_final$source_year_published),
             h_newest = max(cross_sectional_psychosis_publications_final$source_year_published),
             i = nrow(longitudinal_depression_publications_final),
             i_oldest=min(longitudinal_depression_publications_final$source_year_published),
             i_newest = max(longitudinal_depression_publications_final$source_year_published),
             j = nrow(longitudinal_anxiety_publications_final), 
             j_oldest=min(longitudinal_anxiety_publications_final$source_year_published),
             j_newest = max(longitudinal_anxiety_publications_final$source_year_published),
             k = nrow(longitudinal_psychosis_publications_final), 
             k_oldest=min(longitudinal_psychosis_publications_final$source_year_published),
             k_newest = max(longitudinal_psychosis_publications_final$source_year_published)
             )


g1 <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot]

# node definitions
node [shape = rectangle, width = 4.5, fillcolor = Linen, fontsize=16]

data1 [label = 'Data', fillcolor = Beige]
a [label = '@@1']
b [label = '@@2']

compound=true;
subgraph cluster_filter {
node [shape=box];
style=dashed;
{{ rank = same; filterby1 filterby2}}

filter [label = 'Filter Dataset']  
filterby1 [label = 'Filter Title by\n Psychosis or\n Depression or Depressive or Depressed\n or Anxiety or Social Phobia or Phobia\n or Panic Disorder or Agoraphobia or\n Mental Health Disorder(s) or\n Mental Disorder(s) or Mental Problem(s)\n or Mental Health Problem(s)\n or Mental illness\n or Mental Health illness\n or Mental Health Conditions', width = 4.5]
filterby2 [label = 'Filter Field of Study by\n Psychosis or\n Depression or Depressive or Depressed\n or Anxiety or Social Phobia or Phobia\n or Panic Disorder or Agoraphobia or\n Mental Health Disorder(s) or\n Mental Disorder(s) or Mental Problem(s)\n or Mental Health Problem(s)\n or Mental illness\n or Mental Health illness\n or Mental Health Conditions', width = 4.5]
}

c [label = '@@3', shape = rectangle, width = 4.5]
d [label = '@@4', width = 4, shape=box]
e [label = '@@5', width = 4, shape=box]


f [label = '@@6', width = 3, shape=box]
g [label = '@@7', width = 3, shape=box]
h [label = '@@8', width = 3, shape=box]

i [label = '@@9', width = 3, shape=box]
j [label = '@@10', width = 3, shape=box]
k [label = '@@11', width = 3, shape=box]


# edge definitions with the node IDs

data1 -> a -> b -> filter

filter -> {filterby1, filterby2} [style = dashed]

filterby1 -> filterby2 [style = dashed, minlen=2, label = 'or', dir=both ]

{filterby1, filterby2} -> c [style = dashed, minlen=2]

c -> {d, e}[minlen=2]

d -> e[minlen=3, style=invis];
{{ rank = same; d e }}
  

d -> {f, g, h}

e -> {i, j, k}

f -> g[style=invis]
g -> h[style=invis]

i -> j[style=invis]
j -> k[style=invis]

}

[1]: paste0('Extracted African Authors List (n = ', data$a, ')', '\\n' , '\\n', '(oldest=', data$a_oldest, ', newest=', data$a_newest, ')')
[2]: paste0('Remove Dupliates on Title (n = ', data$b, ')', '\\n' , '\\n', '(oldest=', data$b_oldest, ', newest=', data$b_newest, ')')
[3]: paste0('Inclusion papers (n = ', data$c, ')', '\\n' , '\\n', '(oldest=', data$c_oldest, ', newest=', data$c_newest, ')')
[4]: paste0('Cross-Sectional  (n = ', data$d, ')', '\\n' , '\\n', '(oldest=', data$d_oldest, ', newest=', data$d_newest, ')')
[5]: paste0('Longitudinal  (n = ', data$e, ')', '\\n' , '\\n', '(oldest=', data$e_oldest, ', newest=', data$e_newest, ')')
[6]: paste0('Depression  (n = ', data$f, ')', '\\n' , '\\n', '(oldest=', data$f_oldest, ', newest=', data$f_newest, ')')
[7]: paste0('Anxiety  (n = ', data$g, ')', '\\n' , '\\n', '(oldest=', data$g_oldest, ', newest=', data$g_newest, ')')
[8]: paste0('Psychosis  (n = ', data$h, ')', '\\n' , '\\n', '(oldest=', data$h_oldest, ', newest=', data$h_newest, ')')
[9]: paste0('Depression  (n = ', data$i, ')', '\\n' , '\\n', '(oldest=', data$i_oldest, ', newest=', data$i_newest, ')')
[10]: paste0('Anxiety  (n = ', data$j, ')', '\\n' , '\\n', '(oldest=', data$j_oldest, ', newest=', data$j_newest, ')')
[11]: paste0('Psychosis  (n = ', data$k, ')', '\\n' , '\\n', '(oldest=', data$k_oldest, ', newest=', data$k_newest, ')')

")

g1

```

```{r}

  g1%>%
    export_svg %>% charToRaw %>% rsvg_png(file = "graph.png")

```

# **QA/QC Data**

## Random Selection of Exclusion Data

```{r random selection}

exclusion_data <- mental_health_publications_exclusion_final%>%
  mutate(number= 1:n())

set.seed(1111)
exclusion_random <- round(runif(20, min = min(exclusion_data$number), max = max(exclusion_data$number)),0)

exclusion_data_random <- tibble(random_number = c(exclusion_random))%>%
  left_join(exclusion_data, by = c("random_number" = "number"))

```


```{r saving inclusion and exclusion}

#readr::write_csv(mental_health_publications_final,"mental_health_publications_final.csv", na="")

inclusion_data <- mental_health_publications_inclusion_final%>%
  mutate(number= 1:n())

inclusion_cross_sectional_data <- cross_sectional_publications_final%>%
  mutate(number= 1:n())

inclusion_longitudinal_data <- longitudinal_publications_final%>%
  mutate(number= 1:n())

writexl::write_xlsx(list(inclusion = inclusion_data,
                         exclusion = exclusion_data,
                         exclusion_random = exclusion_data_random,
                         inclusion_cross_sectional = inclusion_cross_sectional_data,
                         inclusion_longitudinal = inclusion_longitudinal_data),
                    "mental_health_publications_inclusion_exclusion_final.xlsx")

```


