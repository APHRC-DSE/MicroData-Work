---
title: "Diabetes WDF baseline"
author: "Reinpeter"
date: "`r Sys.Date()`"
output:
  word_document: 
    number_sections: yes
  pdf_document:
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
---

# **Introduction**

This study titled [**Improving the lives of diabetics in Nairobi's slum through access to quality health care**](https://microdataportal.aphrc.org/index.php/catalog/75) was under the **Health and Well-Being (HaW) Theme** and aimed to improve the management of diabetes and other comorbidities with emphasis on the use of integrated guidelines and patient empowerment. It was carried out from Individual respondents living in Korogocho and Viwandani informal settlements in Nairobi.

```{r setup, results="hide", include=FALSE}

## Set Chunk requirements
knitr::opts_chunk$set(#include = TRUE,
                      echo=FALSE, message = FALSE, warning = FALSE)

```

```{r setting working directory, include=FALSE, results = "hide"}

## Setting work directory

setwd(".")

```


```{r loading relevant packages, include=FALSE, results = "hide"}

#library we need
libs_diabetes_baseline <- c("googledrive" ,"tidyverse", "haven", "janitor", "knitr",
                            "lubridate", "plotly", "gtsummary", "flextable", "psych", "performance", 
                            "GPArotation", "nFactors", "Hmisc")

#install missing libraries

inatalled_libs_diabetes_baseline <- libs_diabetes_baseline  %in% rownames(installed.packages())
if (any(inatalled_libs_diabetes_baseline==F)) {
  install.packages(libs_diabetes_baseline[!inatalled_libs_diabetes_baseline])
}

#load libraries

invisible(lapply(libs_diabetes_baseline, library, character.only=T))


set_gtsummary_theme(list(
  "tbl_summary-fn:percent_fun" = function(x) style_percent(x, digits = 1),
  "tbl_summary-str:categorical_stat" = "{n} ({p}%)"
))
# Setting `Compact` theme
theme_gtsummary_compact()

```


```{r googledrive downloading diabetes data, results="hide", include=FALSE}

 drive_auth(#email = "guest360@aphrc.org"
           )

  #drive_user()

  diabetes_baseline_file_id <- drive_find(shared_drive = c(shared_drive_find(pattern = "Data Science Programs")$id),
           q = c("name = 'wdfbaseline_cleaned.dta'")) #search for a specific set of shared drives, use the query string q
  

  diabetes_baseline_local_download <- drive_download(diabetes_baseline_file_id$id, overwrite = TRUE)

  
  diabetes_followup_file_id <- drive_find(shared_drive = c(shared_drive_find(pattern = "Data Science Programs")$id),
           q = c("name = 'wdffollowup_cleaned.dta'")) #search for a specific set of shared drives, use the query string q

  
  diabetes_followup_local_download <- drive_download(diabetes_followup_file_id$id, overwrite = TRUE)

```


```{r reading diabetes data locally, results="hide", include=FALSE}

  ##Reading the .dta with labelled vector converted to a factor
  
  diabetes_followup <- read_dta("wdffollowup_cleaned.dta")%>%
  mutate_if(haven::is.labelled, as_factor)

  diabetes_baseline <- read_dta("wdfbaseline_cleaned.dta")%>%
  mutate_if(is.labelled, as_factor)%>%
   labelled::set_variable_labels( #relabeling specific variables
     wdf_q2_3a = "For how long have you had diabetes, since you were diagnosed (units-D, W, M, Y)?",
     wdf_q2_3b = "For how long have you had diabetes, since you were diagnosed (# of units)?",
     wdf_q2_6 = "How would you describe your treatment for diabetes?",
     wdf_q2_7a = "Medication you were taking to treat the Diabetes? - Tablets prescribed by a health worker",
     wdf_q2_7b = "Medication you were taking to treat the Diabetes? - Tablets i got from a drug store without a prescription",
     wdf_q2_7c = "Medication you were taking to treat the Diabetes? - Tablets i got from relatives/friends w/o prescription",
     wdf_q2_7d = "Medication you were taking to treat the Diabetes? - Injections (insulin)",
     wdf_q2_7e = "Medication you were taking to treat the Diabetes? - Herbal medicine together with tabs/insulin",
     wdf_q2_7f = "Medication you were taking to treat the Diabetes? - Herbal medicine only",
     wdf_q2_7g = "Medication you were taking to treat the Diabetes? - Other",
     wdf_q2_7sp = "Medication you were taking to treat the Diabetes? - Other specified",
     wdf_q2_8a = "Where were you getting treatment for Diabetes before you started attending this clinic? - Kenyatta national hospital",
     wdf_q2_8b = "Where were you getting treatment for Diabetes before you started attending this clinic? - Govt district hospital",
     wdf_q2_8bsp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Govt district hospital specified",
     wdf_q2_8c = "Where were you getting treatment for Diabetes before you started attending this clinic? - Govt health centre",
     wdf_q2_8csp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Govt health centre specified",
     wdf_q2_8d = "Where were you getting treatment for Diabetes before you started attending this clinic? - Private hospital",
     wdf_q2_8dsp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Private hospital specified",
     wdf_q2_8e = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other hospital",
     wdf_q2_8esp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other hospital specified",
     wdf_q2_8f = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other health facility",
     wdf_q2_8fsp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other health facility specified",
     wdf_q2_8g = "Where were you getting treatment for Diabetes before you started attending this clinic? - I started treatment from here",
     wdf_q2_8h = "Where were you getting treatment for Diabetes before you started attending this clinic? - I don't remember",
     wdf_q2_8i = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other",
     wdf_q2_8isp = "Where were you getting treatment for Diabetes before you started attending this clinic? - Other specified",
     wdf_q2_11a = "How long have you had high BP, since you were diagnosed (units-D, W, M, Y)?",
     wdf_q2_11b = "How long have you had high BP, since you were diagnosed (# of units)?",
     wdf_q2_14 = "How would you describe your treatment for high bp?",
     wdf_q2_15a = "Medication you were taking to treat the Hypertension? - Tablets prescribed by a health worker",
     wdf_q2_15b = "Medication you were taking to treat the Hypertension? - Tablets i got from a drug store without a prescription",
     wdf_q2_15c = "Medication you were taking to treat the Hypertension? - Tablets i got from relatives/friends w/o prescription",
     wdf_q2_15d = "Medication you were taking to treat the Hypertension? - Herbal medicine together with tabs",
     wdf_q2_15e = "Medication you were taking to treat the Hypertension? - Herbal medicine only",
     wdf_q2_15f = "Medication you were taking to treat the Hypertension? - Other",
     wdf_q2_15fsp = "What kind of medication were you taking to treat the Hypertension? - Other specified",
     wdf_q2_16a = "Where were you getting treatment for High BP before you started attending this clinic? - Kenyatta national hospital",
     wdf_q2_16b = "Where were you getting treatment for High BP before you started attending this clinic? - Govt district hospital",
     wdf_q2_16bsp = "Where were you getting treatment for High BP before you started attending this clinic? - Govt district hospital specified",
     wdf_q2_16c = "Where were you getting treatment for High BP before you started attending this clinic? - Govt health centre",
     wdf_q2_16csp = "Where were you getting treatment for High BP before you started attending this clinic? - Govt health centre specified",
     wdf_q2_16d = "Where were you getting treatment for High BP before you started attending this clinic? - Private hospital",
     wdf_q2_16dsp = "Where were you getting treatment for High BP before you started attending this clinic? - Private hospital specified",
     wdf_q2_16e = "Where were you getting treatment for High BP before you started attending this clinic? - Other hospital",
     wdf_q2_16esp = "Where were you getting treatment for High BP before you started attending this clinic? - Other hospital specified",
     wdf_q2_16f = "Where were you getting treatment for High BP before you started attending this clinic? - Other health facility",
     wdf_q2_16fsp = "Where were you getting treatment for High BP before you started attending this clinic? - Other health facility specified",
     wdf_q2_16g = "Where were you getting treatment for High BP before you started attending this clinic? - I started treatment from here",
     wdf_q2_16h = "Where were you getting treatment for High BP before you started attending this clinic? - I don't remember",
     wdf_q2_16i = "Where were you getting treatment for High BP before you started attending this clinic? - Other",
     wdf_q2_16isp = "Where were you getting treatment for High BP before you started attending this clinic? - Other specified",
     wdf_q2_19a = "Have peripheral neuropathy complication",
     wdf_q2_19b = "Have poor vision complication",
     wdf_q2_19d = "Have kidney problems complication",
     wdf_q2_19e = "Have chest pain complication",
     wdf_q2_19f = "Have body swelling (abdominal or pedal oedema) complication",
     wdf_q3_9 = "In the past, did you ever use smokeless tobacco daily?",
     wdf_q5_3a = "Blood pressure today-Systolic",
     wdf_q5_3b = "Blood pressure today-Diastolic",
     wdf_q5_10 = "Blood glucose (mmol/L)",
     wdf_q5_11 = "Hba1c measurement (%)"
     )

  
  diabetes_baseline1 <- read_dta("wdfbaseline_cleaned.dta") #read_dta(paste0(diabetes_baseline_local_download$local_path))
  
 
  diabetes_baseline_variable_attr <- as.data.frame(labelled::generate_dictionary(diabetes_baseline))

  diabetes_baseline_variable_attr1 <- as.data.frame(labelled::look_for(diabetes_baseline1, labels = TRUE, values = TRUE))

```


```{r assigning variable labels, results="hide", include=FALSE}

#Creating a named vector to quickly assign the variable labels

diabetes_baseline_labels <- diabetes_baseline_variable_attr%>%
  select(variable, label)%>%
  deframe()

```


```{r saving data localy, results="hide", include=FALSE}

#saving as .csv
readr::write_csv(diabetes_baseline,"wdfbaseline_cleaned.csv", na="")

```


```{r reading scan report, results="hide", include=FALSE}

#downloading data from shared google drive

scan_report_baseline_id <- drive_find(shared_drive = c(shared_drive_find(pattern = "Data Science Programs")$id),
           q = c("name = 'ScanReport_wdfbaseline.xlsx'")) #search for a specific set of shared drives, use the query string q


scan_report_baseline_local_download <- drive_download(scan_report_baseline_id$id, overwrite = TRUE)

```


```{r creating unique id, results="hide", include=FALSE}

#creating unique id from names of participants from baseline and followup data

unique_id <- rbind(diabetes_baseline%>%dplyr::select(wdf_q1_6, wdf_q1_4),
                   diabetes_followup%>%dplyr::select(wdf_q1_6, wdf_q1_4))%>%
  distinct(wdf_q1_6, wdf_q1_4)%>%
  mutate(study_id = 1:n())%>%
  labelled::set_variable_labels( #relabeling specific variables
    study_id = "Created respondent id"
  )

```


```{r final data, results="hide", include=FALSE}

diabetes_baseline_final <- diabetes_baseline%>%
  left_join(unique_id, 
            by = c("wdf_q1_6" = "wdf_q1_6", "wdf_q1_4" = "wdf_q1_4"))%>%
  dplyr::select(study_id, wdf_q1_2:wdf_q5_11)%>%
   mutate(wdf_q2_2 = if_else(wdf_q2_1 == "Yes" & is.na(wdf_q2_2),  wdf_q1_2- (as.period(str_to_lower(wdf_q2_3a))*(as.numeric(wdf_q2_3b))),
                           wdf_q2_2), #cleaning when you were diagnosed with diabetes column
          wdf_q5_5b = if_else(wdf_q5_5a == 161.1 & wdf_q5_5b == 61, 161, wdf_q5_5b), #cleaning 2nd reading height column
          wdf_q1_4_age = round(time_length(difftime(wdf_q1_2, wdf_q1_4, units = "auto"), unit = "year"),2), #creating age column
          wdf_q1_4_age_group = ifelse(wdf_q1_4_age < 51, "50 and below",
                          ifelse(wdf_q1_4_age  < 61, "51-60 years", "61 years and above" )), #creating age group column
          wdf_q1_4_age_group = factor(wdf_q1_4_age_group, levels = c("50 and below", "51-60 years", "61 years and above")), #factor age group column
          wdf_q2_3a_b_years = round(time_length(as.period(str_to_lower(wdf_q2_3a))*(as.numeric(wdf_q2_3b)), unit = "year"),3), #creating duration of diabetes in years column
          wdf_q2_3a_b_years_group = ifelse(wdf_q2_3a_b_years < 5, "Below 5 years",
                        ifelse(wdf_q2_3a_b_years  < 10, "5-9 years", "10 years and above" )), #creating duration of diabetes in years group column
          wdf_q2_3a_b_years_group = factor(wdf_q2_3a_b_years_group, levels = c("Below 5 years", "5-9 years", "10 years and above")), #factor duration of diabetes in years group column
          wdf_q2_11a = if_else(wdf_q2_11b == 98, "Months", wdf_q2_11a ), #cleaning column
          wdf_q2_11a = factor(wdf_q2_11a, levels = c("Days", "Weeks", "Months", "Years")), #factor cleaned column
          wdf_q2_11a_b_years = round(time_length(as.period(str_to_lower(wdf_q2_11a))*(as.numeric(wdf_q2_11b)), unit = "year"),3), #creating duration of hypertension in years column
          wdf_q2_11a_b_years_group = ifelse(wdf_q2_11a_b_years < 5, "Below 5 years",
                      ifelse(wdf_q2_11a_b_years  < 10, "5-9 years", "10 years and above" )), #creating duration of hypertension in years group column
          wdf_q2_11a_b_years_group = factor(wdf_q2_11a_b_years_group, levels = c("Below 5 years", "5-9 years", "10 years and above")), #factor duration of hypertension in years group column
          wdf_q3_5a_b_years = round(time_length(as.period(str_to_lower(wdf_q3_5a))*(as.numeric(wdf_q3_5b)), unit = "year"),3), #creating duration of how long ago did you stop smoking in years column
          wdf_q3_34a_b_hours = round(time_length(hours(as.numeric(wdf_q3_34a))+minutes(as.numeric(wdf_q3_34b)), unit = "hour"),2), #creating duration of How much time do you spend doing vigorous-intensity activities (hours+min) combined column
          wdf_q3_37a_b_hours = round(time_length(hours(as.numeric(wdf_q3_37a))+minutes(as.numeric(wdf_q3_37b)), unit = "hour"),2), #creating duration of How much time do you spend doing moderate-intensity activities (hours+min) combined column
          wdf_q3_40a_b_hours = round(time_length(hours(as.numeric(wdf_q3_40a))+minutes(as.numeric(wdf_q3_40b)), unit = "hour"),2), #creating duration of How much time do you spend walking or cycling (hours+min) combined column
          wdf_q3_43a_b_hours = round(time_length(hours(as.numeric(wdf_q3_43a))+minutes(as.numeric(wdf_q3_43b)), unit = "hour"),2), #creating duration of How much time do you spend on vigorous-intensity sports (hours+min) combined column
          wdf_q3_46a_b_hours = round(time_length(hours(as.numeric(wdf_q3_46a))+minutes(as.numeric(wdf_q3_46b)), unit = "hour"),2), #creating duration of How much time do you spend on moderate-intensity sports (hours+min) combined column
          wdf_q3_47a_b_hours = round(time_length(hours(as.numeric(wdf_q3_47a))+minutes(as.numeric(wdf_q3_47b)), unit = "hour"),2), #creating duration of How much time do you usually spend sitting or reclining (hours+min) combined column
          wdf_q5_1_2_3a = round(rowMeans(across(c(wdf_q5_1a,wdf_q5_2a,wdf_q5_3a)), na.rm = TRUE),0), #creating average Systolic BP column
          wdf_q5_1_2_3b = round(rowMeans(across(c(wdf_q5_1b,wdf_q5_2b,wdf_q5_3b)), na.rm = TRUE),0), #creating average Diastolic BP column
          wdf_q5_bp = ifelse(wdf_q5_1_2_3a <120 & wdf_q5_1_2_3b <80, "< 120/80", ">=120/80"), #Creating < 120/80 & >=120/80 BP group column
          wdf_q5_bp = factor(wdf_q5_bp, levels = c("< 120/80", ">=120/80")), #factor < 120/80 & >=120/80 BP group column
          wdf_q5_5a_b = round(rowMeans(across(c(wdf_q5_5a, wdf_q5_5b)), na.rm = TRUE)/100,2), #creating average height in meters column
          wdf_q5_6_7 = round(rowMeans(across(c(wdf_q5_6, wdf_q5_7)), na.rm = TRUE),1), #creating average weight in meters column
          wdf_q5_5_6_7_bmi = round(wdf_q5_6_7/((wdf_q5_5a_b)^2),2), #creating BMI column
          wdf_q5_5_6_7_bmi_group = ifelse(wdf_q5_5_6_7_bmi <18.5, "Underweight (<18.5)",
                                    ifelse(wdf_q5_5_6_7_bmi <25, "Normal (18.5–24.9)",
                                    ifelse(wdf_q5_5_6_7_bmi <30, "Overweight (25–29.9)", "Obese (>=30)"))), #Creating BMI group column
          wdf_q5_5_6_7_bmi_group = factor(wdf_q5_5_6_7_bmi_group, levels = c("Underweight (<18.5)", "Normal (18.5–24.9)",
                                                    "Overweight (25–29.9)", "Obese (>=30)")), #factor BMI group column
          wdf_q5_8a_b_waist_hip_ratio = round(wdf_q5_8a/wdf_q5_8b,2), #creating waist hip ratio column
          wdf_q5_8a_b_waist_hip_ratio_group = ifelse(wdf_q1_5== "Female" & wdf_q5_8a_b_waist_hip_ratio <=0.86, "Normal (Male <=0.95; Female <=0.86)",
                                              ifelse(wdf_q1_5== "Male" & wdf_q5_8a_b_waist_hip_ratio <=0.95, "Normal (Male <=0.95; Female <=0.86)",
                                                     "At Risk (Male >0.95; Female >0.86)")), #creating waist hip ratio group column
          wdf_q5_8a_b_waist_hip_ratio_group = factor(wdf_q5_8a_b_waist_hip_ratio_group,
                                        levels = c("Normal (Male <=0.95; Female <=0.86)", "At Risk (Male >0.95; Female >0.86)")), #factor waist hip ratio group column
          wdf_q5_10_group = ifelse(wdf_q5_10 <3.9, "Low (<3.9)",
                            ifelse(wdf_q5_10 <=5.6, "Normal (3.9-5.6)",
                            ifelse(wdf_q5_10 <7, "At Risk (5.7-6.9)", "High (>=7)"))), #Creating blood glucose group column
          wdf_q5_10_group = factor(wdf_q5_10_group, levels = c("Low (<3.9)", "Normal (3.9-5.6)", "At Risk (5.7-6.9)", "High (>=7)"))
          #factor blood glucose group column
            )%>%
  labelled::set_variable_labels(!!!diabetes_baseline_labels[names(diabetes_baseline_labels) %in% names(.)])%>% #labeling variables from data dictionary 
   labelled::set_variable_labels( #creating labels for new variables
     wdf_q1_4_age = "Respondent's age in years",
     wdf_q1_4_age_group = "Respondent's age group",
     wdf_q2_3a_b_years = "Duration of diabetes (years)",
     wdf_q2_3a_b_years_group = "Duration of diabetes (years) group",
     wdf_q2_11a_b_years = "Duration of high BP (years)",
     wdf_q2_11a_b_years_group = "Duration of hig BP (years) group",
     wdf_q3_5a_b_years = "How long ago did you stop smoking daily? (in years)",
     wdf_q3_34a_b_hours = "How much time do you spend doing vigorous-intensity activities in hrs (combined hours + min)",
     wdf_q3_37a_b_hours = "How much time do you spend doing moderate-intensity activities in hrs (combined hours + min)",
     wdf_q3_40a_b_hours = "How much time do you spend walking or cycling in hrs (combined hours + min)",
     wdf_q3_43a_b_hours = "How much time do you spend on vigorous-intensity sports in hrs (combined hours + min)",
     wdf_q3_46a_b_hours = "How much time do you spend on moderate-intensity sports in hrs (combined hours + min)",
     wdf_q3_47a_b_hours = "How much time do you usually spend sitting or reclining in hrs (combined hours + min)",
     wdf_q5_1_2_3a = "Systolic Blood pressure",
     wdf_q5_1_2_3b = "Diastolic Blood pressure",
     wdf_q5_bp = "Blood Pressure (mmHg)",
     wdf_q5_5a_b = "Height in metres",
     wdf_q5_6_7 = "Weight in kgs", 
     wdf_q5_5_6_7_bmi = "BMI (kg/m2)",
     wdf_q5_5_6_7_bmi_group = "BMI (kg/m2) group",
     wdf_q5_8a_b_waist_hip_ratio = "Waist-to-hip ratio",
     wdf_q5_8a_b_waist_hip_ratio_group = "Waist-to-hip ratio group",
     wdf_q5_10_group = "Blood glucose (mmol/L) group"
   )%>%
  mutate_if(is.factor, ~fct_drop(.x #, only = c()
            )) #drop unused factor levels

```


```{r final raw clean data, results="hide", include=FALSE}

diabetes_baseline_final_raw <- diabetes_baseline_final%>%
  mutate(
    across(c(wdf_q3_2, wdf_q3_3, wdf_q3_4, wdf_q3_7, wdf_q3_8, wdf_q3_9), ~ as.character(.x)), #Change columns to character
    across(c(wdf_q3_2, wdf_q3_3, wdf_q3_4, wdf_q3_7, wdf_q3_8, wdf_q3_9), ~ ifelse(is.na(.x), "No", .x)), #Replace NA to No
    across(c(wdf_q3_2, wdf_q3_3, wdf_q3_4, wdf_q3_7, wdf_q3_8, wdf_q3_9), ~ factor(.x, levels = c("Yes", "No")) ), #convert Column to Factor
    wdf_q3_13 = ifelse(wdf_q3_10 == "No", NA, wdf_q3_13), #Replace condition 9 to NA
    wdf_q3_14 = fct_collapse(wdf_q3_14, No = c("No", "9")), #factor collapse column
    wdf_q3_15 = fct_collapse(wdf_q3_15, Yes = c("Yes", "9")), #factor collapse column
    across(c(wdf_q3_17a, wdf_q3_17b, wdf_q3_17c, wdf_q3_17d, wdf_q3_17e, wdf_q3_17f), ~ as.character(.x)), #Change columns to character
    across(c(wdf_q3_17a, wdf_q3_17b, wdf_q3_17c, wdf_q3_17d, wdf_q3_17e, wdf_q3_17f), 
           ~ ifelse(wdf_q3_15 == "Yes" & .x == "9", NA, .x)), #Replace condition 9 to NA
    across(c(wdf_q3_17a, wdf_q3_17b, wdf_q3_17c, wdf_q3_17d, wdf_q3_17e, wdf_q3_17f), 
           ~ factor(.x, levels = c("Yes", "No", "9")) ), #convert Column to Factor
   across(c(wdf_q3_17a, wdf_q3_17b, wdf_q3_17c, wdf_q3_17d, wdf_q3_17e, wdf_q3_17f),
          ~ fct_collapse(.x, No = c("No", "9") ) ), #Factor collapse column
   across(c(wdf_q3_31a, wdf_q3_31b, wdf_q3_31c, wdf_q3_31e, wdf_q3_31f), ~ na_if(.x, 99)), #convert 99 to NA
   wdf_q4_10 = fct_collapse(wdf_q4_10, 'Very Unhappy' = c("Very Unhappy", "6")),#factor collapse column
   wdf_q2_9_17a = ifelse(wdf_q2_9 == "Yes" | wdf_q2_17a == "Yes", "Yes", "No"),
   wdf_q2_17b_c_d = ifelse(wdf_q2_17b == "Yes" | wdf_q2_17c == "Yes" | wdf_q2_17d == "Yes", "Yes", "No"),
   wdf_q2_19f_q5_0c = if_else(wdf_q2_19f == "Yes" | wdf_q5_0c == "Yes", "Yes", wdf_q2_19f),
   diabetes_comobidities = ifelse(wdf_q2_9_17a == "Yes" | wdf_q2_17b_c_d == "Yes" | wdf_q2_17e == "Yes" | wdf_q2_17f == "Yes"
                                   | wdf_q2_17g == "Yes" | wdf_q2_17h == "Yes" | wdf_q2_17i == "Yes", "Yes", "No"),
   diabetes_related_complications = ifelse(wdf_q2_19a == "Yes" | wdf_q2_19b == "Yes" | wdf_q2_19c == "Yes" |
                                   wdf_q2_19d == "Yes" | wdf_q2_19e == "Yes" | wdf_q2_19f_q5_0c == "Yes" , "Yes",
                                   ifelse(wdf_q2_19a == "Dont Know" & wdf_q2_19b == "Dont Know" & wdf_q2_19c == "Dont Know" &
                                   wdf_q2_19d == "Dont Know" & wdf_q2_19e == "Dont Know" & wdf_q2_19f_q5_0c == "Dont Know" ,
                                   "Dont Know", "No")),
   wdf_q3_32_35 = ifelse(wdf_q3_32 == "Yes" | wdf_q3_35 == "Yes", "Yes", "No"),
   wdf_q3_41_44 = ifelse(wdf_q3_41 == "Yes" | wdf_q3_44 == "Yes", "Yes", "No"),
   wdf_q3_24 = fct_collapse(wdf_q3_24, 'Daily/5-6 days per week' = c("Daily", "5-6 days per week"),
                            '1-3/1-4 days per week' = c("1-4 days per week", "1-3 days per week"),
                            'Once/2-3 times a year' = c("2-3 times a year", "Once a year")), #factor collapse column
   across(c(wdf_q3_25a, wdf_q3_25b), ~fct_collapse(.x, 
                            'Daily/5-6 days per week' = c("More than once a day", "Once daily", "5-6 days a week"),
                            'Once/2-3 times a month' = c("2-3 times a month", "Once a month", "Less than once a month"))), #factor collapse column
   wdf_q3_25c = fct_collapse(wdf_q3_25c, 'Daily/5-6 days per week' = c("Once daily", "5-6 days a week"),
                            'Once/2-3 times a month' = c("2-3 times a month", "Once a month", "Less than once a month")), #factor collapse column
   wdf_q3_25d = fct_collapse(wdf_q3_25d, 'Daily/5-6 days per week' = c("5-6 days a week"),
                            'Once/2-3 times a month' = c("2-3 times a month", "Once a month", "Less than once a month")), #factor collapse column
   wdf_q3_25e = fct_collapse(wdf_q3_25e, 'Daily/5-6 days per week' = c("More than once a day", "5-6 days a week"),
                            'Once/2-3 times a month' = c("2-3 times a month", "Once a month", "Less than once a month")), #factor collapse column
   wdf_q3_30 = fct_collapse(wdf_q3_30, 'Once/Less than once' = c("Once", "Less than once"),
                            '4-5 times/More than 5 times' = c("4-5 times", "More than 5 times")), #factor collapse column
   wdf_q3_24 = factor(wdf_q3_24, levels = c("Daily/5-6 days per week", "1-3/1-4 days per week", "Less than once a month",
                                                "Once/2-3 times a year", "Never")),
   across(c(wdf_q3_25a, wdf_q3_25b, wdf_q3_25c, wdf_q3_25d, wdf_q3_25e), ~ factor(.x, 
                              levels = c("Daily/5-6 days per week", "3-4 days a week", "1-2 times a week",
                                                "Once/2-3 times a month", "Never"))),
   wdf_q3_30 = factor(wdf_q3_30, levels = c("Never", "Once/Less than once", "2-3 times", "4-5 times/More than 5 times")),
   across(c(wdf_q4_1:wdf_q4_10), ~ fct_rev(.x)), #Reverse factor levels
   wdf_q2_7a_b_c = ifelse(wdf_q2_7a == "Yes" | wdf_q2_7b == "Yes" | wdf_q2_7c == "Yes", "Yes", "No"),
   wdf_q2_7a_b_c_d = ifelse(wdf_q2_7a_b_c == "Yes" & wdf_q2_7d == "Yes", "Yes", "No"),
   across(c(wdf_q2_7a_b_c, wdf_q2_7a_b_c_d, wdf_q2_9_17a, wdf_q2_17b_c_d, diabetes_comobidities, wdf_q3_32_35, wdf_q3_41_44),
          ~ factor(.x, levels = c("Yes", "No"))),
   across(c(wdf_q2_19f_q5_0c, diabetes_related_complications), ~ factor(.x, levels = c("Yes", "No", "Dont Know"))),
   wdf_q4_1_numeric = as.numeric(wdf_q4_1),
   wdf_q4_2_numeric = as.numeric(wdf_q4_2),
   wdf_q4_3_numeric = as.numeric(wdf_q4_3),
   wdf_q4_4_numeric = as.numeric(wdf_q4_4),
   wdf_q4_5_numeric = as.numeric(wdf_q4_5),
   wdf_q4_6_numeric = as.numeric(wdf_q4_6),
   wdf_q4_7_numeric = as.numeric(wdf_q4_7),
   wdf_q4_8_numeric = as.numeric(wdf_q4_8),
   wdf_q4_9_numeric = as.numeric(wdf_q4_9),
   wdf_q4_10_numeric = as.numeric(wdf_q4_10),
   wdf_q4_qol10 = rowMeans(across(c(wdf_q4_1_numeric:wdf_q4_10_numeric)), na.rm = TRUE),
   wdf_q4_qol10_transformed = (wdf_q4_qol10-1)*(100/4),
   wdf_q4_overall_qol_transformed = (wdf_q4_9_numeric-1)*(100/4),
   wdf_q4_overall_health_transformed = (wdf_q4_3_numeric-1)*(100/4))%>%
  labelled::set_variable_labels(!!!diabetes_baseline_labels[names(diabetes_baseline_labels) %in% names(.)])%>% #labeling variables from data dictionary
  labelled::set_variable_labels( #creating labels for new variables
     wdf_q2_7a_b_c = "Medication you were taking to treat the Diabetes? - Tablets",
     wdf_q2_7a_b_c_d = "Medication you were taking to treat the Diabetes? - Tablets together with Injections (insulin)",
     wdf_q2_9_17a = "Ever been diagnosed with high BP/Hypertension",
     wdf_q2_17b_c_d = "Ever been diagnosed with heart attack/angina/any other heart disease",
     wdf_q2_19f_q5_0c = "Have body swelling (abdominal or pedal oedema) complication",
     diabetes_comobidities = "Diabetes co-mobidities",
     diabetes_related_complications = "Diabetes-related complications",
     wdf_q3_32_35 = "Involved in moderate/vigorous intensity activity",
     wdf_q3_41_44 = "Do any moderate/vigorous intensity sports, fitness or recreational?",
     wdf_q4_1_numeric = "Do you have enough energy for everyday life? - Scores",
     wdf_q4_2_numeric = "Do you have enough money to meet your  basic needs? - Score",
     wdf_q4_3_numeric = "How satisfied are you with your health? - Score",
     wdf_q4_4_numeric = "How satisfied are you with yourself? - Score",
     wdf_q4_5_numeric = "How satisfied are you with your daily living activities? - Score",
     wdf_q4_6_numeric = "How satisfied are you with your personal relationships? - Score",
     wdf_q4_7_numeric = "How satisfied are you with the  conditions of your living place? - Score",
     wdf_q4_8_numeric = "How satisfied are you with your life as a whole? - Score",
     wdf_q4_9_numeric = "How would you rate your overall quality of life? - Score",
     wdf_q4_10_numeric = "How would you say you are these days? - Score",
     wdf_q4_qol10 = "QOL10 Scores",
     wdf_q4_qol10_transformed = "QOL10 Transformed Scores",
     wdf_q4_overall_qol_transformed = "Overall quality of life Transformed Scores",
     wdf_q4_overall_health_transformed = "Overall health satisfaction Transformed Scores "
   )

```


# **Exploratory factor analysis**

Exploratory Factor analysis using princomp(), principal, MinRes (minimum residual), Principal Axis, Weighted Least Squares or Maximum Likelihood.

Factoring method fm="minres" will do a minimum residual as will fm="uls". Both of these use a first derivative. 
fm="ols" differs very slightly from "minres" in that it minimizes the entire residual matrix using an OLS procedure but uses the empirical first derivative. This will be slower. 
fm="wls" will do a weighted least squares (WLS) solution, 
fm="gls" does a generalized weighted least squares (GLS), 
fm="pa" will do the principal factor solution, 
fm="ml" will do a maximum likelihood factor analysis. 
fm="minchi" will minimize the sample size weighted chi square when treating pairwise correlations with different number of subjects per pair. 
fm ="minrank" will do a minimum rank factor analysis. 
"old.min" will do minimal residual the way it was done prior to April, 2017 (see discussion below). 
fm="alpha" will do alpha factor analysis as described in Kaiser and Coffey (1965)

Factor rotation is a technique used to transform factors gained from the factor analysis (FA) so that the factor loadings that are small would be minimized, and factor loadings that are large would be maximized in order to enhance the interpretability oft hese factors (Field, 2013; Warner, 2013, p. 848).

The major difference between orthogonal and oblique rotation is that the orthogonal rotation preserves the orthogonality of the factors (i.e., the correlations between them remain equal to zero), whereas the oblique rotation allows the new factors to be correlated.

orthogonal rotations are "none", "varimax", "quartimax", "bentlerT", "equamax", "varimin", "geominT" and "bifactor"  

oblique transformations are "Promax", "promax", "oblimin", "simplimax", "bentlerQ, "geominQ" and "biquartimin" and "cluster"

The default is oblimin transformation, although versions prior to 2009 defaulted to varimax.

Some advantages of orthogonal rotations are that they provide results that are simpler due to the preserved orthogonality offactors and might be easier to interpret. Orthogonal rotations also produce lower sampling errors, and the results from theserotations are more likely to be replicated in further studies (Kieffer, 1998, p. 12). An important limitation is that “underlyingfactors” are rarely completely uncorrelated if they correspond to something, in reality, so orthogonal rotations tend tooversimplify the model (Field, 2013; Kieffer, 1998).

On the contrary, oblique rotations allow for the best fit of the model to the gathered data, and they may better correspond tothe scholar’s view about the world (Kieffer, 1998; Warner, 2013). However, a limitation is that these results are more difficult tointerpret, for oblique rotations produce more data to be assessed (Kieffer, 1998, p. 16).


```{r}
qol_df <- diabetes_baseline_final_raw%>%
  dplyr::select(wdf_q4_1_numeric:wdf_q4_10_numeric)

sapply(qol_df,function(x) sum(is.na(x)))

#correlation
correlation_qol <- cor(qol_df) #method = c("pearson", "kendall", "spearman"); 
#use = "everything", "all.obs", "complete.obs", "na.or.complete", or "pairwise.complete.obs".

#Covariance
covariance_qol <- cov(qol_df)

variables_qol <- ncol(qol_df)

observations_qol <- nrow(qol_df)

```

## Suitability of Data for EPA

```{r suitability of data for factor analysis}

#Check suitability of data for Factor Analysis (FA) with Bartlett's Test of Sphericity and 
#KMO (Kaiser, Meyer, Olkin) Measure of Sampling Adequacy (MSA)

performance::check_factorstructure(qol_df)

#check_kmo()
#check_sphericity_bartlett()

```

## Determining the Number of Factors to Extract

A crucial decision in exploratory factor analysis is how many factors to extract. The nFactors package offer a suite of functions to aid in this decision.

```{r factor analysis number of factors}

# Determine Number of Factors to Extract

eigen_values_qol <- eigen(correlation_qol) # get eigenvalues

ap <- nFactors::parallel(subject=observations_qol,var=variables_qol,rep=100,cent=.05)
nS <- nScree(x=eigen_values_qol$values, aparallel=ap$eigen$qevpea)

plotnScree(nS)

factors_to_extract_eigen_qol <- nS$Components$nkaiser

factors_to_extract_parallel_qol <- nS$Components$nparallel

```


## Princomp

princomp() uses Spectral decomposition which examines the covariances / correlations between variables.

PCA makes the assumption that there is no unique variance. total variance is equal to common variance. if the total variance is 1, then the common variance is equal to the communality(h2)

```{r factor analysis princomp}

### Perform PCA

qol_pca <- princomp(qol_df, cor = FALSE, scores = TRUE) ##produces an unrotated principal component analysis.

summary(qol_pca)
#loadings(qol_pca)

#The first three principal component explains the 65% proportion of the total variance.

loadings_pca <- qol_pca$loadings
print(loadings_pca, cutoff = 0.4)

```

## Principal

Does an eigen value decomposition and returns eigen values, loadings, and degree of fit for a specified number of components. Basically it is just doing a principal components analysis (PCA) for n principal components of either a correlation or covariance matrix. Can show the residual correlations as well. The quality of reduction in the squared correlations is reported by comparing residual correlations to original correlations. Unlike princomp, this returns a subset of just the best nfactors. The eigen vectors are rescaled by the sqrt of the eigen values to produce the component loadings more typical in factor analysis.


```{r factor analysis principal}

qol_principal <- psych::principal(correlation_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=FALSE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input.
 scores=TRUE, #	If TRUE, find component scores
 missing=FALSE, #if scores are TRUE, and missing=TRUE, then impute missing values using either the median or the mean
 impute="median", #"median" or "mean" values are used to replace missing values
 oblique.scores=TRUE, #If TRUE (default), then the component scores are based upon the structure matrix. If FALSE, upon the pattern matrix.
 method="regression", #Which way of finding component scores should be used. The default is "regression"
 use ="pairwise", #How to treat missing data, use="pairwise" is the default". See cor for other options.
 cor="cor", #How to find the correlations: "cor" is Pearson", "cov" is covariance, "tet" is tetrachoric, "poly" is polychoric, "mixed" uses mixedCor for a mixture of tetrachorics, polychorics, Pearsons, biserials, and polyserials, Yuleb is Yulebonett, Yuleq and YuleY are the obvious Yule coefficients as appropriate
 correct=.5,
 weight=NULL #If not NULL, a vector of length n.obs that contains weights for each observation. The NULL case is equivalent to all cases being weighted 1.
 )

qol_principal

```

## Maximum Likelihood

```{r factor analysis maximum likelihood}

qol_ml <- fa(covariance_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          fm="ml",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=TRUE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input. if covar is TRUE, factor the covariance matrix, otherwise factor the correlation matrix
)

qol_ml

#stats::factanal()

```

## MinRes (minimum residual)

Attempts to minimize the off diagonal residual correlation matrix by adjusting the eigen values of the original correlation matrix.

```{r factor analysis minres}

qol_minres <- fa(covariance_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          fm="minres",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=TRUE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input. if covar is TRUE, factor the covariance matrix, otherwise factor the correlation matrix
)

qol_minres

#psych::factor.minres()

```

## Principal Axis

Instead of guessing 1 as the initial communality, it chooses the squared multiple correlation coefficient R2. To see this in action for Item 1  run a linear regression where Item 1 is the dependent variable and Items 2 -9 are independent variables. R2  estimates of the 9 linear regressions matches the initial communality estimate for Item 1-9.

```{r factor analysis principal axis}

qol_pa <- fa(covariance_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          fm="pa",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=TRUE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input. if covar is TRUE, factor the covariance matrix, otherwise factor the correlation matrix
)

qol_pa

#psych::factor.pa()

```

## Weighted Least Squares

Minimizes the squared residuals, whereby it by weights the squared residuals by their uniquenesses. This tends to produce slightly smaller overall residuals.

```{r factor analysis weighted least squares}

qol_wls <- fa(covariance_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          fm="wls",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=TRUE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input. if covar is TRUE, factor the covariance matrix, otherwise factor the correlation matrix
)

qol_wls

#psych::factor.wls()

```

## alpha Factor analysis

This new procedure (alpha factor analysis, AFA) determines factors which have maximum generalizability in the Kuder-Richardson, or alpha, sense. 

```{r factor analysis alpha}

qol_alpha <- fa(covariance_qol, 
          nfactors = factors_to_extract_parallel_qol, #Number of components to extract
          residuals = FALSE, #FALSE, do not show residuals, TRUE, report residuals
          rotate="oblimin",
          fm="alpha",
          n.obs=observations_qol, #Number of observations used to find correlation matrix.Used for finding goodness of fit statistics.
          covar=TRUE, #If false, find the correlation matrix from the raw data or convert to a correlation matrix if given a square matrix as input. if covar is TRUE, factor the covariance matrix, otherwise factor the correlation matrix
)

qol_alpha

```

The Alpha FA extracted two significant factors which together explained 44% of the variance. PCA extracted two significant factors which together explained 54% of the variance. Factor loadings of 0.4 or above were considered relevant.

The first factor of the two retained factors is interpreted as “Global QoL”, and includes 8 items on overall assessment of
QoL, overall assessment of health, physical health (energy and living activities), mental health (how one feels about oneself, life and general feeling) and having enough money for basic needs.

The second retained factor is interpreted as “social/environment” and contains 2 items on one's personal relationships and living conditions.

Using the items determined relevant to each factor, subscales were derived using the same methodology as the WHOQOL-BREF’s domain scores.

```{r final clean data, results="hide", include=FALSE}

diabetes_baseline_final_clean <- diabetes_baseline_final_raw%>%
  mutate(wdf_q4_factor1_global_qol = rowMeans(across(c(wdf_q4_1_numeric:wdf_q4_5_numeric, wdf_q4_8_numeric:wdf_q4_5_numeric )),
                                              na.rm = TRUE),
   wdf_q4_factor1_global_qol_transformed = (wdf_q4_factor1_global_qol-1)*(100/4),
   wdf_q4_factor2_social_environment_qol = rowMeans(across(c(wdf_q4_6_numeric, wdf_q4_7_numeric )), na.rm = TRUE),
   wdf_q4_factor2_social_environment_qol_transformed = (wdf_q4_factor2_social_environment_qol-1)*(100/4)
     )%>%
  labelled::set_variable_labels( #creating labels for new variables
     wdf_q4_factor1_global_qol = "Factor Analysis Subscale 1 (Global QOL:Q1,Q2,Q3,Q4,Q5,Q8,Q9,Q10) - Score",
     wdf_q4_factor1_global_qol_transformed = "Factor Analysis Subscale 1 (Global QOL:Q1,Q2,Q3,Q4,Q5,Q8,Q9,Q10) - Transformed Scores",
     wdf_q4_factor2_social_environment_qol = "Factor Analysis Subscale 2 (Social/Environment QOL:Q6,Q7) - Score",
     wdf_q4_factor2_social_environment_qol_transformed = "Factor Analysis Subscale 2 (Social/Environment QOL:Q6,Q7) - Transformed Scores "
   )
  
```


```{r diabetes baseline final data for analysis, results="hide", include=FALSE}

# make dataset with variables for descriptive and inferential statistics

  diabetes_baseline_final_analysis <- diabetes_baseline_final_clean%>%
  dplyr::select( #consent
    wdf_q1_10, wdf_q1_11, wdf_q1_12,
    #socio-demographics
    wdf_q1_5, wdf_q1_4_age, wdf_q1_4_age_group,
    #History of medical conditions and treatment
    wdf_q2_1, wdf_q2_3a_b_years, wdf_q2_3a_b_years_group, wdf_q2_7a_b_c, wdf_q2_7d, wdf_q2_7a_b_c_d, wdf_q2_7e, 
    wdf_q2_9_17a, wdf_q2_17b_c_d, wdf_q2_17e, wdf_q2_17f, wdf_q2_17g, 
    wdf_q2_17h, wdf_q2_17i, diabetes_comobidities, wdf_q2_19a:wdf_q2_19e, wdf_q2_19f_q5_0c, diabetes_related_complications,
    #Lifestyle history/Health behaviour
    wdf_q3_2, wdf_q3_7, wdf_q3_10, wdf_q3_14,
    wdf_q3_18, wdf_q3_20, wdf_q3_22:wdf_q3_26, wdf_q3_29, wdf_q3_30,  
    wdf_q3_32_35, wdf_q3_38, wdf_q3_41_44, wdf_q3_47a_b_hours, wdf_q3_48,
    #Well being and Quality of life
    wdf_q4_1:wdf_q4_10, wdf_q4_1_numeric:wdf_q4_10_numeric, wdf_q4_qol10, wdf_q4_qol10_transformed,  
    wdf_q4_overall_qol_transformed, wdf_q4_overall_health_transformed, wdf_q4_factor1_global_qol,
    wdf_q4_factor1_global_qol_transformed, wdf_q4_factor2_social_environment_qol, wdf_q4_factor2_social_environment_qol_transformed,
    #Clinical and anthropometric measurements
    wdf_q5_0a:wdf_q5_0b, wdf_q5_1_2_3a, wdf_q5_1_2_3b, wdf_q5_bp, wdf_q5_5_6_7_bmi, wdf_q5_5_6_7_bmi_group,
    wdf_q5_8a_b_waist_hip_ratio, wdf_q5_8a_b_waist_hip_ratio_group, wdf_q5_10, wdf_q5_10_group
                )

```


```{r saving locally followup final clean data, results="hide", include=FALSE}

#saving final followup data
save(diabetes_baseline_final_clean, diabetes_baseline_final_analysis, file = "wdfbaseline_cleaned_final.RData")

```


# **Data-Baseline**

Data collected face to face on clinical attendees using (WDF_Baseline - Questionnaire) included:

* Demographic identifiers (respondentID, age and sex).

* history of medical conditions and treatment

* lifestyle history/Health behaviour

* well being and quality of life

* clinical and anthropometric measurements.


## Data description

* The data has `r ncol(diabetes_baseline)` variables and `r nrow(diabetes_baseline)` observations.

* All `r nrow(diabetes_baseline[diabetes_baseline$wdf_q1_10=="Yes",])` individuals accepted to participate in the study with `r paste0("(",round((nrow(diabetes_baseline[diabetes_baseline$wdf_q1_11=="Signs",])*100)/nrow(diabetes_baseline),1), "%)")` signing to show that they had accepted to participate in the study. 


```{r data description}

  tbl_summary(diabetes_baseline_final_analysis%>%dplyr::select(wdf_q1_10, wdf_q1_11, wdf_q1_12, wdf_q2_1),
              by = wdf_q2_1,
                      type = list(
                        all_dichotomous() ~ "categorical")
                      , digits = list(all_continuous() ~ 2, 
                                      all_categorical() ~ c(0, 1))
                      , missing = "no" #list missing data separately #ifany #no #always
                      ,missing_text = "Missing"
                      ) %>% 
  modify_header(label = "**Descriptives**") %>% # update the column header
  bold_labels() %>%
  italicize_levels()%>%
  add_n( statistic = "{n}", col_label = "**n**", last = FALSE, footnote = FALSE)%>% # add column with total number of non-missing observations
  add_overall() %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Diabetic**")%>%
  #modify_caption("**Table 1. Patient Characteristics**")%>%
  modify_footnote(
    all_stat_cols() ~ "Frequency (%)"
  )%>%
  as_flex_table() #covert gtsummary object to flex table object.

```

## Data Dictionary

Information about the attributes of diabetes baseline data contains 6 columns namely:

- **pos:** Column position of variable in data
- **variable:** Study variable
- **label:** Description of study variable
- **col_type:** Data type. i.e dbl(numeric variable), fct(categorical variable), date(date variable), chr(character/string variable)
- **levels:** variable levels/categories
- **value_labels:** value of variable categories

```{r data dictionary, results='asis'}

kable(
  diabetes_baseline_variable_attr%>%
    mutate(value_labels = diabetes_baseline_variable_attr1$value_labels)
  )

```


## Data Analysis

The quantitative data was cleaned and analysed using R version 4.2.3 (2023). 

Descriptive summary statistics in form of frequency, percentage, mean and standard deviation were generated to examine socio-demographic, history of medical conditions and treatment, lifestyle history/Health behaviour, well being/quality of life and clinical and anthropometric measurements variables.

Chi-square test and Fisher's exact test where appropriate were used for categorical data to analyze difference in proportion of socio-demographic, history of medical conditions and treatment, lifestyle history/Health behaviour, well being/quality of life and clinical and anthropometric measurements variables as a function of gender and age group. 

For continous data, Wilcoxon rank sum test, Welch Two Sample t-test and Kruskal-Wallis rank sum test where appropriate was used to examine the comparison of gender and age group  with various continous variables.

The results are presented in narrative and summary tables. Statistical significance was set at p<0.05

# **Descriptive statistics**

```{r final variables descriptives}

 tbl_summary(diabetes_baseline_final_analysis, include = -c(wdf_q1_10, wdf_q1_11, wdf_q1_12),
              by = wdf_q2_1,
                      type = list(
                        c(wdf_q3_18, wdf_q3_20,
                          wdf_q4_1_numeric:wdf_q4_10_numeric, wdf_q4_qol10, wdf_q4_qol10_transformed,  
    wdf_q4_overall_qol_transformed, wdf_q4_overall_health_transformed, 
    wdf_q4_factor1_global_qol,wdf_q4_factor1_global_qol_transformed, 
    wdf_q4_factor2_social_environment_qol, wdf_q4_factor2_social_environment_qol_transformed) ~ "continuous2",
                        all_dichotomous() ~ "categorical"
                         ,all_continuous() ~ "continuous2"
                        )
                      , statistic = all_continuous() ~ c(
                                      "{mean} ({sd})", 
                                      "{median} ({p25}, {p75})", 
                                      "{min}, {max}")
                       , digits = list(all_continuous() ~ 2, 
                                      all_categorical() ~ c(0, 1))
                      ,percent = "column" #"column", "row", or "cell"
                      , missing = "always" #list missing data separately #ifany #no #always
                      ,missing_text = "Missing"
                      ) %>% 
  modify_header(label = "**Variables**") %>% # update the column header
  bold_labels() %>%
  italicize_levels()%>%
  add_n( statistic = "{n}", col_label = "**n**", last = FALSE, footnote = FALSE)%>% # add column with total number of non-missing observations
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3),
        test.args = all_tests("fisher.test") ~ list(simulate.p.value=TRUE)) %>%
   bold_p(t= 0.05) %>% # bold p-values under a given threshold (default 0.05)
  add_overall() %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Diabetic**")%>%
  modify_footnote(
    all_stat_cols() ~ "Mean (SD); Median (IQR); Range; Frequency (%)"
  )%>%
  as_flex_table() #covert gtsummary object to flex table object.

```


# **Inferential statistics**

## Gender

```{r final variables by gender}

  tbl_strata(diabetes_baseline_final_analysis,
               strata = wdf_q2_1,
               .tbl_fun = ~ .x %>%
               tbl_summary( by = wdf_q1_5, include = -c(wdf_q1_10, wdf_q1_11, wdf_q1_12),
                      type = list(
                        c(wdf_q3_18, wdf_q3_20,
                          wdf_q4_1_numeric:wdf_q4_10_numeric, wdf_q4_qol10, wdf_q4_qol10_transformed,  
    wdf_q4_overall_qol_transformed, wdf_q4_overall_health_transformed, 
    wdf_q4_factor1_global_qol,wdf_q4_factor1_global_qol_transformed, 
    wdf_q4_factor2_social_environment_qol, wdf_q4_factor2_social_environment_qol_transformed) ~ "continuous2",
                        all_dichotomous() ~ "categorical"
                         ,all_continuous() ~ "continuous2"
                        )
                      , statistic = all_continuous() ~ c(
                                      "{mean} ({sd})", 
                                      "{median} ({p25}, {p75})", 
                                      "{min}, {max}")
                       , digits = list(all_continuous() ~ 2, 
                                      all_categorical() ~ c(0, 1))
                      ,percent = "column" #"column", "row", or "cell"
                      , missing = "always" #list missing data separately #ifany #no #always
                      ,missing_text = "Missing"
                      ) %>% 
  modify_header(label = "**Variables**") %>% # update the column header
  bold_labels() %>%
  italicize_levels()%>%
  add_n( statistic = "{n}", col_label = "**n**", last = FALSE, footnote = FALSE)%>% # add column with total number of non-missing observations
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3),
        test.args = all_tests("fisher.test") ~ list(simulate.p.value=TRUE)) %>%
   bold_p(t= 0.05) %>% # bold p-values under a given threshold (default 0.05)
  modify_footnote(
    all_stat_cols() ~ "Mean (SD); Median (IQR); Range; Frequency (%)"
  ),
    .header = "**Diabetes {strata}**, N = {n}"
 )

```


## Age group

```{r final variables by age group}

  tbl_strata(diabetes_baseline_final_analysis,
               strata = wdf_q2_1,
               .tbl_fun = ~ .x %>%
               tbl_summary( by = wdf_q1_4_age_group, include = -c(wdf_q1_10, wdf_q1_11, wdf_q1_12),
                      type = list(
                        c(wdf_q3_18, wdf_q3_20,
                          wdf_q4_1_numeric:wdf_q4_10_numeric, wdf_q4_qol10, wdf_q4_qol10_transformed,  
    wdf_q4_overall_qol_transformed, wdf_q4_overall_health_transformed, 
    wdf_q4_factor1_global_qol,wdf_q4_factor1_global_qol_transformed, 
    wdf_q4_factor2_social_environment_qol, wdf_q4_factor2_social_environment_qol_transformed) ~ "continuous2",
                        all_dichotomous() ~ "categorical"
                         ,all_continuous() ~ "continuous2"
                        )
                      , statistic = all_continuous() ~ c(
                                      "{mean} ({sd})", 
                                      "{median} ({p25}, {p75})", 
                                      "{min}, {max}")
                       , digits = list(all_continuous() ~ 2, 
                                      all_categorical() ~ c(0, 1))
                      ,percent = "column" #"column", "row", or "cell"
                      , missing = "always" #list missing data separately #ifany #no #always
                      ,missing_text = "Missing"
                      ) %>% 
  modify_header(label = "**Variables**") %>% # update the column header
  bold_labels() %>%
  italicize_levels()%>%
  add_n( statistic = "{n}", col_label = "**n**", last = FALSE, footnote = FALSE)%>% # add column with total number of non-missing observations
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3),
        test.args = all_tests("fisher.test") ~ list(simulate.p.value=TRUE)) %>%
   bold_p(t= 0.05) %>% # bold p-values under a given threshold (default 0.05)
  modify_footnote(
    all_stat_cols() ~ "Mean (SD); Median (IQR); Range; Frequency (%)"
  ),
    .header = "**Diabetes {strata}**, N = {n}"
 )

```


# **Reliability Analysis of Quality of Life Tool**

raw_alpha: Cronbach’s $\alpha$ (values ≥ .7 or .8 indicate good reliability; Kline (1999))

## QOL10

```{r reliability qol10}

qol_10_questions <- diabetes_baseline_final_analysis%>%
  dplyr::select(wdf_q4_1_numeric:wdf_q4_10_numeric)

psych::alpha(qol_10_questions)

```


## Factor 1: globalQOL

```{r reliability factor 1 subscale}

qol_factor_1_subscale_questions <- diabetes_baseline_final_analysis%>%
  dplyr::select(wdf_q4_1_numeric:wdf_q4_5_numeric, wdf_q4_8_numeric:wdf_q4_5_numeric)

psych::alpha(qol_factor_1_subscale_questions)

```

## Factor 2: globalQOL

```{r reliability factor 2 subscale}

qol_factor_2_subscale_questions <- diabetes_baseline_final_analysis%>%
  dplyr::select(wdf_q4_6_numeric, wdf_q4_7_numeric)

psych::alpha(qol_factor_2_subscale_questions)

```


# **Correlation of QOL Transformed Scores**

```{r correlation coefficient of QOL transformed scores}

qol_transformed_df <- diabetes_baseline_final_analysis%>%
  dplyr::select(wdf_q4_qol10_transformed, wdf_q4_overall_qol_transformed, wdf_q4_overall_health_transformed, 
    wdf_q4_factor1_global_qol_transformed, wdf_q4_factor2_social_environment_qol_transformed)

correlation_coef_qol_transformed <- cor(qol_transformed_df)

kable(correlation_coef_qol_transformed)

```

```{r correlation pvalue of QOL transformed scores}

correlation_sign_qol_transformed <- Hmisc::rcorr(as.matrix(qol_transformed_df)) # rcorr() accepts matrices only

# display p-values (rounded to 3 decimals)
kable(
  round(correlation_sign_qol_transformed$P, 3)
)

```



